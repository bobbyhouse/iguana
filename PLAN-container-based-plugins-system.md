# Iguana v2: Container-Based Plugin Architecture

## Summary

Rewrite iguana from a Go-specific static analysis tool into a container-based,
plugin-driven evidence generation system. Evidence bundles can be produced from
diverse sources — not just Go static analysis. The current Go analyzer becomes
the first plugin.

Iguana becomes workspace-oriented: evidence bundles are stored in containers
(`~/.iguana/[name]/`) outside the source tree.

The evidence bundles serve as an **abbreviated semantic index for LLMs** —
enough context to understand a system without repeated discovery, with references
to drill into source material when needed.

## Containers

A container is a directory at `~/.iguana/[name]/` that holds project
configurations and generated evidence bundles.

### Structure

```
~/.iguana/foo/
  backend.yaml          # project config
  frontend.yaml         # project config
  backend/
    static/
      schema.md
      (evidence bundles)
  frontend/
    static/
      schema.md
      (evidence bundles)
    slack/
      schema.md
      (evidence bundles)
```

- Project yamls live at the root of the container directory.
- Each project gets a subdirectory named after the project.
- Within a project directory, each plugin gets its own subdirectory.
- Each plugin's schema description file is copied into its output directory
  at analyze time.

### CLI

- **`iguana init foo`** — creates `~/.iguana/foo/`. Errors if it already exists.
- **`iguana add foo backend`** — interactive setup using bubbletea. Prompts the
  user to select plugins, then asks plugin-specific configuration questions.
  Writes `~/.iguana/foo/backend.yaml`. Errors if `backend.yaml` already exists.
- **`iguana analyze foo`** — processes all projects in the container. For each
  project, runs each configured plugin. Evidence bundles are written to
  `~/.iguana/foo/[project-name]/[plugin-name]/`.

There is no command to analyze a single project within a container.

### Project YAML

Generated by `iguana add` from interactive prompts. Contains plugin
configuration:

```yaml
plugins:
  static:
    repository: git://github.com/org/backend.git
```

### Source Fetching

Each plugin is responsible for fetching its own source material:

- The Go static analyzer clones/pulls a git repo.
- A Slack plugin would call the Slack API.
- A Google Docs plugin would fetch the document.

For git-based plugins, source material is fetched using a shallow clone
(`git clone --depth 1`) by shelling out to `git`. If the URL includes a
specific ref (branch, tag, commit), that ref is checked out. Otherwise the
default branch is used. The temp directory is left as-is after analysis
(not cleaned up).

## Evidence Bundle Format

Evidence bundles are **markdown files with YAML frontmatter and an optional
markdown body**.

```
---
plugin: static
schema: schema.md
hash: abc123def456
# ... plugin-specific structured data ...
---

(optional markdown content)
```

### Rules

- Every evidence bundle is a markdown file (`.md` extension) with YAML
  frontmatter.
- The YAML frontmatter contains common fields (see below) followed by
  plugin-specific structured data.
- The markdown body is optional. Plugins that deal with narrative content
  (Slack messages, documents) can include excerpts or summaries. Plugins that
  produce purely structured data (Go AST) can leave the body empty.
- Output must be deterministic: same input produces the same output.
- Each plugin defines its own file naming convention and granularity (per file,
  per package, per channel, etc.).

### Common Frontmatter Fields

Every evidence bundle has these required fields:

- `plugin` — the name of the plugin that generated this bundle.
- `schema` — a relative file path to a markdown document that describes
  the plugin-specific fields in this bundle.
- `hash` — a stable identifier derived from the input, used for staleness
  detection. If the hash hasn't changed, the bundle does not need to be
  regenerated.

Everything else in the frontmatter is plugin-specific.

### Schema Descriptions

Each plugin type has a single schema description file — a markdown document
written in English that explains the fields the plugin produces. This file
lives in the plugin's source directory and is embedded in the binary. At
analyze time, it is copied into the plugin's output directory within the
container. Bundles reference it via a relative path (e.g., `schema: schema.md`).

### Parsing

Parsing frontmatter is straightforward in Go — split on `---` delimiters,
unmarshal the YAML between them, treat everything after as markdown. This can
be done in ~15-20 lines with no external dependencies.

## References

Evidence bundles contain references that allow an LLM to drill down from the
abbreviated index into source material.

### Convention

Any field anywhere in the plugin-specific YAML can include a `ref` field
containing a URL. This is a convention, not a fixed schema position — `ref`
appears wherever it is relevant in the structured data.

All references use URL schemes to be unambiguous and self-describing:

- **Git source** — `git://github.com/org/repo@abc123/internal/fs/writer.go#L42`
- **Local file** — `file://./schema.md`
- **Local file with anchor** — `file://./schema.md#section-heading`
- **External URL** — `https://docs.google.com/document/d/...`

### Examples

Go static analyzer — references point to exact locations in source code:

```yaml
functions:
  - name: WriteFile
    ref: git://github.com/org/repo@abc123/internal/fs/writer.go#L42
    returns: [error]
```

Slack plugin — references point to extracted content in the markdown body:

```yaml
decisions:
  - topic: authentication approach
    ref: "file://./decisions.md#auth-discussion-2026-02-10"
    summary: Team decided on OAuth2
```

## Plugin Interface

Plugins are compiled-in Go interface implementations. No framework, no RPC,
no discovery mechanism.

```go
type ConfigQuestion struct {
    Key    string // config key to store the answer under
    Prompt string // question text shown to the user
    Type   string // input type, e.g. "text"
}

type EvidenceProducer interface {
    Name() string
    Configure() ([]ConfigQuestion, error)
    Analyze(config map[string]string, outputDir string) error
}
```

Plugins are registered in a map:

```go
var plugins = map[string]EvidenceProducer{
    "static": &GoAnalyzer{},
}
```

### Design Constraints

- `Analyze` receives the plugin's config from the project YAML and the output
  directory path. The plugin fetches source material, generates evidence
  bundles, copies its schema description file, and writes everything to the
  output directory. It returns an error on failure.
- `Configure` returns the questions needed for interactive setup via
  `iguana add`. For the Go static analyzer, this is a single text input for
  the git repository URL.
- Each plugin defines its own schema, file naming, and granularity.
- Plugins are responsible for fetching their own source material.
- For now there is only one plugin (the Go static analyzer), so there is no
  need to expose plugin selection to the user beyond the `iguana add` prompts.
- The current Go analyzer is refactored behind this interface.
- Interactive prompts use bubbletea.

## Changes to the Current Codebase

1. **Remove existing functionality** — remove `system-model`, `obsidian-vault`,
   `clean`, and `blast` commands and their implementations. Remove the
   existing `analyze` command. Remove internal packages `model`, `obsidian`,
   `export`, and `settings`. Remove BAML files. Remove all associated tests.
2. **Rewrite `INVARIANT.md`** for the new system.
3. **Define the plugin interface** in a new package (e.g., `internal/plugin`).
4. **Implement the container system** — `init`, `add`, and `analyze`
   commands that work with `~/.iguana/[name]/` directories.
5. **Write a frontmatter parser** — small utility to split a markdown file into
   YAML and body sections, and to produce a markdown file from YAML + body.
6. **Refactor the Go analyzer** to implement the `EvidenceProducer` interface.
   Move Go-specific analysis behind the interface boundary. Add git
   clone/pull for source fetching (shallow clone, shelling out to `git`).
   Add `ref` fields pointing to git URLs with commit hash and line numbers.
7. **Write the Go schema description** — a markdown file describing the fields
   the Go static analyzer produces, embedded in the binary.
8. **Update evidence bundle file format** — change from `.evidence.yaml` to
   markdown files with YAML frontmatter.

## Scope

This plan covers evidence bundle generation only. The following commands from
the current iguana are **not part of this work** and may be revisited later:

- `system-model`
- `obsidian-vault`
- `clean`
- `blast`

The CLI for this phase is: `iguana init`, `iguana add`, and `iguana analyze`.
